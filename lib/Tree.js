"use strict";

require("source-map-support/register");

const {
  _
} = require('rk-utils');

const Tree = Node => {
  var _class, _temp;

  return _temp = _class = class extends Node {
    find(predicate) {
      let queue = Node.cloneChildrenList(this);

      while (queue.length > 0) {
        let node = queue.shift();
        if (predicate(node)) return node;
        queue = queue.concat(Node.cloneChildrenList(node));
      }

      return undefined;
    }

  }, _class.Node = Node, _temp;
};

class DataNode {
  static cloneChildrenList(node) {
    return node.children.concat();
  }

  constructor(data) {
    this.children = [];
    this.data = data;
  }

  get size() {
    return this.children.length;
  }

  append(node) {
    if (!(node instanceof DataNode)) {
      throw new Error("Function  precondition failed: node instanceof DataNode");
    }

    node.parent = this;
    this.children.push(node);
  }

  insert(i, node) {
    if (!(node instanceof DataNode)) {
      throw new Error("Function  precondition failed: node instanceof DataNode");
    }

    node.parent = this;
    this.children.splice(Math.max(0, i), 0, node);
  }

  remove(node) {
    if (node.parent !== this) {
      throw new Error('Removing a node which is not a child of the current node.');
    }

    this.children = _.reject(this.children, n => n === node);
    delete node.parent;
    return node;
  }

  removeAtIndex(i) {
    let [removed] = this.children.splice(i, 1);

    if (removed) {
      delete removed.parent;
    }

    return removed;
  }

}

class KeyDataNode {
  static cloneChildrenList(node) {
    return Object.values(node.children);
  }

  constructor(key, data) {
    this.children = {};
    this.key = key;
    this.data = data;
  }

  get size() {
    return Object.keys(this.children).length;
  }

  findByKeyPath(keys) {
    keys = keys.concat();

    if (keys.length === 0 || keys[0] !== this.key) {
      return undefined;
    }

    let value = {
      children: {
        [this.key]: this
      }
    };

    _.find(keys, key => {
      value = value.children[key];
      return typeof value === 'undefined';
    });

    return value;
  }

  appendDataByKeyPath(keys, data) {
    keys = keys.concat();

    if (keys.length === 0 || keys[0] !== this.key) {
      throw new Error(`The given key path "${keys.join(' / ')}" is not starting from the correct initial key "${this.key}".`);
    }

    let lastKey = keys.pop();
    let lastNode = {
      children: {
        [this.key]: this
      }
    },
        node;

    _.each(keys, key => {
      if (key in lastNode.children) {
        lastNode = lastNode.children[key];
      } else {
        node = new KeyDataNode(key);
        lastNode.append(node);
        lastNode = node;
      }
    });

    node = new KeyDataNode(lastKey, data);
    lastNode.append(node);
    return node;
  }

  append(node) {
    if (!(node instanceof KeyDataNode)) {
      throw new Error("Function  precondition failed: node instanceof KeyDataNode");
    }

    node.parent = this;

    if (this.children.hasOwnProperty(node.key)) {
      throw new Error(`Duplicate node key: ${node.key}`);
    }

    this.children[node.key] = node;
  }

  remove(node) {
    if (node.parent !== this || !this.children.hasOwnProperty(node.key)) {
      throw new Error('Removing a node which is not a child of the current node.');
    }

    delete this.children[node.key];
    delete node.parent;
    return node;
  }

  getKeyPath() {
    let paths = [this.key];
    let curr = this;

    while (curr.parent) {
      curr = curr.parent;
      paths.push(curr.key);
    }

    return paths.reverse();
  }

}

module.exports = {
  Tree: Tree(DataNode),
  KeyTree: Tree(KeyDataNode)
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9UcmVlLmpzIl0sIm5hbWVzIjpbIl8iLCJyZXF1aXJlIiwiVHJlZSIsIk5vZGUiLCJmaW5kIiwicHJlZGljYXRlIiwicXVldWUiLCJjbG9uZUNoaWxkcmVuTGlzdCIsImxlbmd0aCIsIm5vZGUiLCJzaGlmdCIsImNvbmNhdCIsInVuZGVmaW5lZCIsIkRhdGFOb2RlIiwiY2hpbGRyZW4iLCJjb25zdHJ1Y3RvciIsImRhdGEiLCJzaXplIiwiYXBwZW5kIiwicGFyZW50IiwicHVzaCIsImluc2VydCIsImkiLCJzcGxpY2UiLCJNYXRoIiwibWF4IiwicmVtb3ZlIiwiRXJyb3IiLCJyZWplY3QiLCJuIiwicmVtb3ZlQXRJbmRleCIsInJlbW92ZWQiLCJLZXlEYXRhTm9kZSIsIk9iamVjdCIsInZhbHVlcyIsImtleSIsImtleXMiLCJmaW5kQnlLZXlQYXRoIiwidmFsdWUiLCJhcHBlbmREYXRhQnlLZXlQYXRoIiwiam9pbiIsImxhc3RLZXkiLCJwb3AiLCJsYXN0Tm9kZSIsImVhY2giLCJoYXNPd25Qcm9wZXJ0eSIsImdldEtleVBhdGgiLCJwYXRocyIsImN1cnIiLCJyZXZlcnNlIiwibW9kdWxlIiwiZXhwb3J0cyIsIktleVRyZWUiXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxNQUFNO0FBQUVBLEVBQUFBO0FBQUYsSUFBUUMsT0FBTyxDQUFDLFVBQUQsQ0FBckI7O0FBY0EsTUFBTUMsSUFBSSxHQUFHQyxJQUFJO0FBQUE7O0FBQUEsMEJBQUksY0FBY0EsSUFBZCxDQUFtQjtBQU9wQ0MsSUFBQUEsSUFBSSxDQUFDQyxTQUFELEVBQVk7QUFDWixVQUFJQyxLQUFLLEdBQUdILElBQUksQ0FBQ0ksaUJBQUwsQ0FBdUIsSUFBdkIsQ0FBWjs7QUFFQSxhQUFPRCxLQUFLLENBQUNFLE1BQU4sR0FBZSxDQUF0QixFQUF5QjtBQUNyQixZQUFJQyxJQUFJLEdBQUdILEtBQUssQ0FBQ0ksS0FBTixFQUFYO0FBRUEsWUFBSUwsU0FBUyxDQUFDSSxJQUFELENBQWIsRUFB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LEVBQUFBLFVBQVUsR0FBRztBQUNULFFBQUlDLEtBQUssR0FBRyxDQUFFLEtBQUtaLEdBQVAsQ0FBWjtBQUNBLFFBQUlhLElBQUksR0FBRyxJQUFYOztBQUVBLFdBQU9BLElBQUksQ0FBQzdCLE1BQVosRUFBb0I7QUFDaEI2QixNQUFBQSxJQUFJLEdBQUdBLElBQUksQ0FBQzdCLE1BQVo7QUFDQTRCLE1BQUFBLEtBQUssQ0FBQzNCLElBQU4sQ0FBVzRCLElBQUksQ0FBQ2IsR0FBaEI7QUFDSDs7QUFFRCxXQUFPWSxLQUFLLENBQUNFLE9BQU4sRUFBUDtBQUNIOztBQXhJYTs7QUEySWxCQyxNQUFNLENBQUNDLE9BQVAsR0FBaUI7QUFDYmpELEVBQUFBLElBQUksRUFBRUEsSUFBSSxDQUFDVyxRQUFELENBREc7QUFFYnVDLEVBQUFBLE9BQU8sRUFBRWxELElBQUksQ0FBQzhCLFdBQUQ7QUFGQSxDQUFqQiIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHsgXyB9ID0gcmVxdWlyZSgncmstdXRpbHMnKTtcblxuLyoqXG4gKiBBIGNsb3N1cmUgZnVuY3Rpb24gdG8gYmUgY2FsbGVkIHRvIGNoZWNrIHRoZSBkYXRhIG9mIGVhY2ggbm9kZSB3aGV0aGVyIG1lZXRzIGNlcnRhaW4gY29uZGl0aW9uXG4gKiBAY2FsbGJhY2sgcHJlZGljYXRlRnVuY3Rpb25cbiAqIEBwYXJhbSB7Tm9kZX0gbm9kZVxuICogQHJldHVybnMge2Jvb2xlYW59XG4gKi9cblxuLyoqXG4gKiBUcmVlIGZhY3RvcnkuXG4gKiBAcGFyYW0ge05vZGV9IE5vZGVcbiAqIEByZXR1cm5zIHtUcmVlfVxuICovXG5jb25zdCBUcmVlID0gTm9kZSA9PiBjbGFzcyBleHRlbmRzIE5vZGUge1xuICAgIHN0YXRpYyBOb2RlID0gTm9kZTtcblxuICAgIC8qKlxuICAgICAqIEZpbmQgYSBub2RlIGJ5IEJGUy5cbiAgICAgKiBAcGFyYW0ge3ByZWRpY2F0ZUZ1bmN0aW9ufSBwcmVkaWNhdGUgXG4gICAgICovXG4gICAgZmluZChwcmVkaWNhdGUpIHtcbiAgICAgICAgbGV0IHF1ZXVlID0gTm9kZS5jbG9uZUNoaWxkcmVuTGlzdCh0aGlzKTtcblxuICAgICAgICB3aGlsZSAocXVldWUubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgbGV0IG5vZGUgPSBxdWV1ZS5zaGlmdCgpO1xuXG4gICAgICAgICAgICBpZiAocHJlZGljYXRlKG5vZGUpKSByZXR1cm4gbm9kZTtcblxuICAgICAgICAgICAgcXVldWUgPSBxdWV1ZS5jb25jYXQoTm9kZS5jbG9uZUNoaWxkcmVuTGlzdChub2RlKSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH0gICAgXG59O1xuXG4vKipcbiAqIFRyZWUgbm9kZSB3aXRoIGRhdGEgcHJvcGVydHkuXG4gKiBAY2xhc3NcbiAqL1xuY2xhc3MgRGF0YU5vZGUge1xuICAgIHN0YXRpYyBjbG9uZUNoaWxkcmVuTGlzdChub2RlKSB7XG4gICAgICAgIHJldHVybiBub2RlLmNoaWxkcmVuLmNvbmNhdCgpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFycmF5IG9mIGNoaWxkcmVuIG5vZGVzLlxuICAgICAqIEBtZW1iZXIge2FycmF5fVxuICAgICAqL1xuICAgIGNoaWxkcmVuID0gW107XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBkYXRhIG5vZGUgd2l0aCBnaXZlbiBkYXRhLlxuICAgICAqIEBwYXJhbSB7Kn0gZGF0YSBcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvcihkYXRhKSB7XG4gICAgICAgIC8qKlxuICAgICAgICAgKiBEYXRhIHByb3BlcnR5LlxuICAgICAgICAgKiBAbWVtYmVyIHsqfVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5kYXRhID0gZGF0YTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBOdW1iZXIgb2Ygbm9kZXMuXG4gICAgICogQG1lbWJlciB7bnVtYmVyfVxuICAgICAqL1xuICAgIGdldCBzaXplKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5jaGlsZHJlbi5sZW5ndGg7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQXBwZW5kIHRoZSBnaXZlbiBub2RlIHRvIHRoZSBlbmQgb2YgdGhlIGNoaWxkcmVuIGxpc3QuXG4gICAgICogQHBhcmFtIHtEYXRhTm9kZX0gbm9kZSBcbiAgICAgKi9cbiAgICBhcHBlbmQobm9kZSkge1xuICAgICAgICBwcmU6IG5vZGUgaW5zdGFuY2VvZiBEYXRhTm9kZTtcblxuICAgICAgICBub2RlLnBhcmVudCA9IHRoaXM7XG4gICAgICAgIHRoaXMuY2hpbGRyZW4ucHVzaChub2RlKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBJbnNlcnQgdGhlIGdpdmVuIG5vZGUgYXQgc3BlY2lmaWVkIGluZGV4IGluIHRoZSBjaGlsZHJlbiBsaXN0LlxuICAgICAqIEBwYXJhbSB7bnVtYmVyfSBpIFxuICAgICAqIEBwYXJhbSB7RGF0YU5vZGV9IG5vZGUgXG4gICAgICovXG4gICAgaW5zZXJ0KGksIG5vZGUpIHtcbiAgICAgICAgcHJlOiBub2RlIGluc3RhbmNlb2YgRGF0YU5vZGU7XG5cbiAgICAgICAgbm9kZS5wYXJlbnQgPSB0aGlzO1xuICAgICAgICB0aGlzLmNoaWxkcmVuLnNwbGljZShNYXRoLm1heCgwLCBpKSwgMCwgbm9kZSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVtb3ZlIHRoZSBnaXZlbiBub2RlIGZyb20gdGhlIGJyYW5jaC5cbiAgICAgKiBAcGFyYW0ge0RhdGFOb2RlfSBub2RlIFxuICAgICAqIEByZXR1cm5zIHtEYXRhTm9kZX1cbiAgICAgKi9cbiAgICByZW1vdmUobm9kZSkge1xuICAgICAgICBpZiAobm9kZS5wYXJlbnQgIT09IHRoaXMpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignUmVtb3ZpbmcgYSBub2RlIHdoaWNoIGlzIG5vdCBhIGNoaWxkIG9mIHRoZSBjdXJyZW50IG5vZGUuJyk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmNoaWxkcmVuID0gXy5yZWplY3QodGhpcy5jaGlsZHJlbiwgbiA9PiBuID09PSBub2RlKTtcbiAgICAgICAgZGVsZXRlIG5vZGUucGFyZW50O1xuXG4gICAgICAgIHJldHVybiBub2RlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlbW92ZSB0aGUgbm9kZSBhdCB0aGUgZ2l2ZW4gaW5kZXggZnJvbSB0aGUgYnJhbmNoLlxuICAgICAqIEBwYXJhbSB7bnVtYmVyfSBpIFxuICAgICAqIEByZXR1cm5zIHtEYXRhTm9kZX0gXG4gICAgICovXG4gICAgcmVtb3ZlQXRJbmRleChpKSB7XG4gICAgICAgIGxldCBbcmVtb3ZlZF0gPSB0aGlzLmNoaWxkcmVuLnNwbGljZShpLCAxKTtcbiAgICAgICAgaWYgKHJlbW92ZWQpIHtcbiAgICAgICAgICAgIGRlbGV0ZSByZW1vdmVkLnBhcmVudDtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZW1vdmVkO1xuICAgIH1cbn1cblxuLyoqXG4gKiBUcmVlIG5vZGUgd2l0aCBrZXkgcHJvcGVydHkgYW5kIGRhdGEgcHJvcGVydHkuXG4gKiBAY2xhc3NcbiAqL1xuY2xhc3MgS2V5RGF0YU5vZGUge1xuICAgIHN0YXRpYyBjbG9uZUNoaWxkcmVuTGlzdChub2RlKSB7XG4gICAgICAgIHJldHVybiBPYmplY3QudmFsdWVzKG5vZGUuY2hpbGRyZW4pO1xuICAgIH1cbiAgICBcbiAgICAvKipcbiAgICAgKiBNYXAgb2Yga2V5cyB0byBjaGlsZHJlbiBub2Rlcy5cbiAgICAgKiBAbWVtYmVyIHtvYmplY3R9XG4gICAgICovXG4gICAgY2hpbGRyZW4gPSB7fTtcblxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBhIGtleS1kYXRhIG5vZGUgd2l0aCBrZXkgYW5kIGdpdmVuIGRhdGEuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSBcbiAgICAgKiBAcGFyYW0geyp9IGRhdGEgXG4gICAgICovXG4gICAgY29uc3RydWN0b3Ioa2V5LCBkYXRhKSB7XG4gICAgICAgIC8qKlxuICAgICAgICAgKiBOb2RlIGtleS5cbiAgICAgICAgICogQG1lbWJlciB7c3RyaW5nfVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5rZXkgPSBrZXk7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIERhdGEgcHJvcGVydHkuXG4gICAgICAgICAqIEBtZW1iZXIgeyp9XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmRhdGEgPSBkYXRhO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIE51bWJlciBvZiBub2Rlcy5cbiAgICAgKiBAbWVtYmVyIHtudW1iZXJ9XG4gICAgICovXG4gICAgZ2V0IHNpemUoKSB7XG4gICAgICAgIHJldHVybiBPYmplY3Qua2V5cyh0aGlzLmNoaWxkcmVuKS5sZW5ndGg7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRmluYSBhIG5vZGUgYnkgcGF0aCBiZWluZyBhbiBhcnJheSBvZiBrZXlzLlxuICAgICAqIEBwYXJhbSB7YXJyYXkuPHN0cmluZz59IGtleXMgXG4gICAgICovXG4gICAgZmluZEJ5S2V5UGF0aChrZXlzKSB7XG4gICAgICAgIGtleXMgPSBrZXlzLmNvbmNhdCgpO1xuXG4gICAgICAgIGlmIChrZXlzLmxlbmd0aCA9PT0gMCB8fCBrZXlzWzBdICE9PSB0aGlzLmtleSkge1xuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCB2YWx1ZSA9IHsgY2hpbGRyZW46IHsgW3RoaXMua2V5XTogdGhpcyB9IH07XG5cbiAgICAgICAgXy5maW5kKGtleXMsIGtleSA9PiB7XG4gICAgICAgICAgICB2YWx1ZSA9IHZhbHVlLmNoaWxkcmVuW2tleV07XG4gICAgICAgICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSAndW5kZWZpbmVkJztcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFwcGVuZCBkYXRhIGJ5IHBhdGggYmVpbmcgYW4gYXJyYXkgb2Yga2V5cy5cbiAgICAgKiBAcGFyYW0ge2FycmF5LjxzdHJpbmc+fSBrZXlzIFxuICAgICAqIEBwYXJhbSB7Kn0gZGF0YSBcbiAgICAgKiBAcmV0dXJucyB7S2V5RGF0YU5vZGV9IFRoZSBuZXdseSBjcmVhdGVkIG5vZGUgY29udGFpbmluZyB0aGUgZGF0YS5cbiAgICAgKi9cbiAgICBhcHBlbmREYXRhQnlLZXlQYXRoKGtleXMsIGRhdGEpIHsgICAgICAgIFxuICAgICAgICBrZXlzID0ga2V5cy5jb25jYXQoKTtcblxuICAgICAgICBpZiAoa2V5cy5sZW5ndGggPT09IDAgfHwga2V5c1swXSAhPT0gdGhpcy5rZXkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVGhlIGdpdmVuIGtleSBwYXRoIFwiJHtrZXlzLmpvaW4oJyAvICcpfVwiIGlzIG5vdCBzdGFydGluZyBmcm9tIHRoZSBjb3JyZWN0IGluaXRpYWwga2V5IFwiJHt0aGlzLmtleX1cIi5gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBsYXN0S2V5ID0ga2V5cy5wb3AoKTtcbiAgICAgICAgbGV0IGxhc3ROb2RlID0geyBjaGlsZHJlbjogeyBbdGhpcy5rZXldOiB0aGlzIH0gfSwgbm9kZTtcblxuICAgICAgICBfLmVhY2goa2V5cywga2V5ID0+IHtcbiAgICAgICAgICAgIGlmIChrZXkgaW4gbGFzdE5vZGUuY2hpbGRyZW4pIHtcbiAgICAgICAgICAgICAgICBsYXN0Tm9kZSA9IGxhc3ROb2RlLmNoaWxkcmVuW2tleV07XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIG5vZGUgPSBuZXcgS2V5RGF0YU5vZGUoa2V5KTtcbiAgICAgICAgICAgICAgICBsYXN0Tm9kZS5hcHBlbmQobm9kZSk7XG4gICAgICAgICAgICAgICAgbGFzdE5vZGUgPSBub2RlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBub2RlID0gbmV3IEtleURhdGFOb2RlKGxhc3RLZXksIGRhdGEpO1xuICAgICAgICBsYXN0Tm9kZS5hcHBlbmQobm9kZSk7XG5cbiAgICAgICAgcmV0dXJuIG5vZGU7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQXBwZW5kIHRoZSBnaXZlbiBub2RlIHRvIHRoZSBlbmQgb2YgdGhlIGNoaWxkcmVuIGxpc3QuXG4gICAgICogQHBhcmFtIHtLZXlEYXRhTm9kZX0gbm9kZSBcbiAgICAgKi9cbiAgICBhcHBlbmQobm9kZSkge1xuICAgICAgICBwcmU6IG5vZGUgaW5zdGFuY2VvZiBLZXlEYXRhTm9kZTtcblxuICAgICAgICBub2RlLnBhcmVudCA9IHRoaXM7XG5cbiAgICAgICAgaWYgKHRoaXMuY2hpbGRyZW4uaGFzT3duUHJvcGVydHkobm9kZS5rZXkpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYER1cGxpY2F0ZSBub2RlIGtleTogJHtub2RlLmtleX1gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuY2hpbGRyZW5bbm9kZS5rZXldID0gbm9kZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZW1vdmUgdGhlIGdpdmVuIG5vZGUgZnJvbSB0aGUgYnJhbmNoLlxuICAgICAqIEBwYXJhbSB7S2V5RGF0YU5vZGV9IG5vZGUgXG4gICAgICovXG4gICAgcmVtb3ZlKG5vZGUpIHtcbiAgICAgICAgaWYgKG5vZGUucGFyZW50ICE9PSB0aGlzIHx8ICF0aGlzLmNoaWxkcmVuLmhhc093blByb3BlcnR5KG5vZGUua2V5KSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdSZW1vdmluZyBhIG5vZGUgd2hpY2ggaXMgbm90IGEgY2hpbGQgb2YgdGhlIGN1cnJlbnQgbm9kZS4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGRlbGV0ZSB0aGlzLmNoaWxkcmVuW25vZGUua2V5XTtcbiAgICAgICAgZGVsZXRlIG5vZGUucGFyZW50O1xuXG4gICAgICAgIHJldHVybiBub2RlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCBrZXkgcGF0aCBvZiBjdXJyZW50IG5vZGUgKGEga2V5IGNoYWluIGZyb20gcm9vdCB0byBpdHNlbGYpLlxuICAgICAqIEByZXR1cm5zIHthcnJheX1cbiAgICAgKi9cbiAgICBnZXRLZXlQYXRoKCkge1xuICAgICAgICBsZXQgcGF0aHMgPSBbIHRoaXMua2V5IF07XG4gICAgICAgIGxldCBjdXJyID0gdGhpcztcblxuICAgICAgICB3aGlsZSAoY3Vyci5wYXJlbnQpIHtcbiAgICAgICAgICAgIGN1cnIgPSBjdXJyLnBhcmVudDtcbiAgICAgICAgICAgIHBhdGhzLnB1c2goY3Vyci5rZXkpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHBhdGhzLnJldmVyc2UoKTtcbiAgICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICAgIFRyZWU6IFRyZWUoRGF0YU5vZGUpLFxuICAgIEtleVRyZWU6IFRyZWUoS2V5RGF0YU5vZGUpXG59OyJdfQ==